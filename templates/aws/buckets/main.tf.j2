
{%for bucket in buckets%}

resource "aws_s3_bucket" "bucket_{{ loop.index }}" {
  bucket = "{{bucket.name}}"
   {%if bucket.tags | length > 0%}
    tags = {
      {%for tag in bucket.tags%}
      "{{tag.key}}" = "{{tag.value}}"
      {%endfor%}
    }
   {%endif%}
}

resource "aws_s3_bucket_ownership_controls" "ownership_controls_{{ loop.index }}" {
  bucket = aws_s3_bucket.bucket_{{ loop.index }}.bucket
  rule {
    object_ownership = "BucketOwnerPreferred"
  }
}

resource "aws_s3_bucket_acl" "acl_bucket_{{ loop.index }}" {
 
  depends_on = [aws_s3_bucket_ownership_controls.ownership_controls_{{ loop.index }}, aws_s3_bucket_public_access_block.public_access_block_{{ loop.index }}]

  bucket = aws_s3_bucket.bucket_{{ loop.index}}.bucket
  acl    = "{{bucket.acl}}"
}

resource "aws_s3_bucket_public_access_block" "public_access_block_{{ loop.index }}" {
  bucket                  = aws_s3_bucket.bucket_{{ loop.index }}.bucket
  block_public_acls       = "{{bucket.block_public_acls}}"
  block_public_policy     = "{{bucket.block_public_policy}}"
  ignore_public_acls      = "{{bucket.ignore_public_acls}}"
  restrict_public_buckets = "{{bucket.restrict_public_buckets}}"
}


{%if bucket.host_website == true%}
resource "aws_s3_bucket_website_configuration" "website_config_{{ loop.index }}" {
  bucket = aws_s3_bucket.bucket_{{ loop.index }}.bucket
  index_document {
    {%if bucket.index_document %}
      suffix = "{{bucket.index_document}}"
      {%else%}
      suffix = "index.html"
    {%endif%}
  }
  
    error_document {
       {%if bucket.error_document %}
          key = "{{bucket.error_document}}"
        {%else%}
          key = "error.html"
        {%endif%}
    }
}
{%endif%}




output "bucket_names_{{ loop.index }}" {
  description = "Names of the created S3 buckets"
  value       = bucket_{{ loop.index }}.bucket
}

output "bucket_names_{{ loop.index }}" {
  description = "ARNs of the created S3 buckets"
  value       = bucket_{{ loop.index }}.arn
}

{%endfor%}